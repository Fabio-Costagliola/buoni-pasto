<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Calcolatore Buoni Pasto</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content: 100%;
        padding: 12px;
        font-size: 18px;
        margin-bottom: 10px;
    }
    button {
        background-color: #007aff;
        color: white;
        border: none;
        border-radius: 6px;
    }

    /* Lista importi */
    #lista ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #lista li {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    #lista li .amount {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Pulsanti icona */
    .icon-btn {
        font-size: 16px;
        padding: 4px 6px;
        line-height: 1;
        min-width: 0;
        width: auto;
        border: none;
        background: transparent;
        color: #333;
        border-radius: 6px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .icon-btn:active {
        background: rgba(0,0,0,0.06);
    }
    .icon-btn.edit {
        color: #ff9500;
    }
    .icon-btn.remove {
        color: #ff3b30;
    }

    footer {
      margin-top: 40px;
      text-align: center;
      opacity: 0.6;
      font-size: 0.9em;
    }
</style>
</head>

<body>

<h2>Calcolatore Buoni Pasto</h2>

<!-- Inserimento importo con espressioni -->
<label>Aggiungi un importo in centesimi (es. 250 oppure 199*2):</label>
<input
  type="text"
  id="importo"
  inputmode="numeric"
  placeholder="es. 199*2"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
/>

<!-- Tastierino operatori -->
<div id="ops" style="display:flex; gap:8px; margin-bottom:10px;">
  <button type="button" onclick="ins('+')">+</button>
  <button type="button" onclick="ins('-')">−</button>
  <button type="button" onclick="ins('*')">×</button>
  <button type="button" onclick="ins('/')">÷</button>
</div>

<button onclick="aggiungiImporto()">Aggiungi</button>

<div id="lista"></div>

<h3>Totale: € <span id="totale">0.00</span></h3>

<button onclick="calcola()">Calcola buoni pasto</button>

<div id="output"></div>

<footer>
    Versione: <span id="versione">caricamento...</span>
</footer>

<script>
// ===== Tastierino: inserimento operatori =====
function ins(op) {
  const input = document.getElementById("importo");
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;

  input.value = input.value.slice(0, start) + op + input.value.slice(end);

  const pos = start + op.length;
  requestAnimationFrame(() => {
    input.focus();
    input.setSelectionRange(pos, pos);
  });
}

// ===== Array importi in centesimi =====
let importi = [];

// ===== Aggiungi importo con parsing matematico =====
function aggiungiImporto() {
  const input = document.getElementById("importo");
  let expr = (input.value || "").trim();
  if (!expr) return;

  expr = expr
    .replace(/×/g, "*")
    .replace(/[xX]/g, "*")
    .replace(/÷/g, "/")
    .replace(/,/g, "")
    .replace(/\s+/g, "");

  const safe = /^[0-9+\-*/()]+$/;
  if (!safe.test(expr)) {
    alert("Espressione non valida. Usa solo numeri e + - * / ( )");
    return;
  }

  let valore;
  try {
    valore = Function("return (" + expr + ")")();
  } catch {
    alert("Espressione non valida");
    return;
  }

  if (typeof valore !== "number" || !isFinite(valore) || valore <= 0) {
    alert("Risultato non valido");
    return;
  }

  const valoreCentesimi = Math.round(valore);

  importi.push(valoreCentesimi);
  input.value = "";
  aggiornaLista();
  aggiornaTotale();
}

// ===== Aggiorna lista =====
function aggiornaLista() {
  let html = "<h3>Importi:</h3><ul>";
  importi.forEach((v, i) => {
    const euro = (v / 100).toFixed(2);
    html += `
      <li>
        <span class="amount">€ ${euro}</span>
        <button class="icon-btn edit" aria-label="Modifica" title="Modifica" onclick="modifica(${i})">✏️</button>
        <button class="icon-btn remove" aria-label="Elimina" title="Elimina" onclick="rimuovi(${i})">❌</button>
      </li>
    `;
  });
  html += "</ul>";
  document.getElementById("lista").innerHTML = html;
}

function rimuovi(i) {
  importi.splice(i, 1);
  aggiornaLista();
  aggiornaTotale();
}

function modifica(i) {
  const nuovo = prompt("Nuovo importo in centesimi:", importi[i]);
  if (nuovo !== null && !isNaN(parseInt(nuovo)) && parseInt(nuovo) > 0) {
    importi[i] = parseInt(nuovo);
    aggiornaLista();
    aggiornaTotale();
  }
}

function aggiornaTotale() {
  const tot = importi.reduce((a, b) => a + b, 0);
  document.getElementById("totale").textContent = (tot / 100).toFixed(2);
}

// ===== Calcolo buoni pasto =====
function calcola() {
  const target = importi.reduce((a, b) => a + b, 0) / 100;
  const small = 7.50;
  const large = 11.35;

  let bestTotal = 0, bestSmall = 0, bestLarge = 0;

  for (let nL = 0; nL <= Math.floor(target / large); nL++) {
    for (let nS = 0; nS <= Math.floor(target / small); nS++) {
      const tot = nL * large + nS * small;
      if (tot <= target && tot > bestTotal) {
        bestTotal = tot;
        bestSmall = nS;
        bestLarge = nL;
      }
    }
  }

  document.getElementById("output").innerHTML = `
    <h3>Risultato:</h3>
    Totale spesa: € ${target.toFixed(2)}<br>
    Coperti dai buoni: € ${bestTotal.toFixed(2)}<br><br>
    Buoni da 11,35 €: <b>${bestLarge}</b><br>
    Buoni da 7,50 €: <b>${bestSmall}</b>
  `;
}

// ===== Mostra versione SW =====
async function mostraVersioneSW() {
  try {
    const resp = await fetch("service-worker.js?nocache=" + Date.now());
    const txt = await resp.text();
    const m = txt.match(/VERSION\s*=\s*[^"']+["']/);
    document.getElementById("versione").textContent = m ? m[1] : "n/d";
  } catch {
    document.getElementById("versione").textContent = "errore";
  }
}
mostraVersioneSW();

// ===== Registrazione SW con aggiornamento immediato =====
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    const reg = await navigator.serviceWorker.register("service-worker.js", {
      updateViaCache: "none"
    });

    reg.update().catch(() => {});

    navigator.serviceWorker.addEventListener("message", ev => {
      if (ev.data?.type === "NEW_VERSION") window.location.reload();
    });

    navigator.serviceWorker.addEventListener("controllerchange", () => {
      window.location.reload();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") reg.update().catch(() => {});
    });

    setInterval(() => reg.update().catch(() => {}), 30000);
  });
}
</script>

</body>
</html>
