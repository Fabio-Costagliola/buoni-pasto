<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">

<!-- comportamento da app -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icon.png">

<title>Buoni Pasto</title>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 480px;
        margin: auto;
    }
    input, button {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        margin-bottom: 10px;
    }
    button {
        background-color: #007aff;
        color: white;
        border: none;
        border-radius: 6px;
    }
    #lista li {
        margin-bottom: 10px;
    }
    .remove-btn {
        width:25%;
        background: #ff3b30: none;
        padding: 5px 10px;
        margin-left: 10px;
        border-radius: 4px;
    }
    .edit-btn {
        width:25%;
        background: #ff9500;
        color: white;
        border: none;
        padding: 5px 10px;
        margin-left: 10px;
        border-radius: 4px;
    }
</style>
</head>

<body>

<h2>Calcolatore Buoni Pasto</h2>

<!-- Inserimento importo in centesimi (supporta espressioni: es. 199*2) -->
<label>Aggiungi un importo in centesimi (es. 250 oppure 199*2):</label>
<input
  type="text"
  id="importo"
  inputmode="numeric"
  placeholder="es. 199*2"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
/>

<!-- Tastierino operatori -->
<div id="ops" style="display:flex; gap:8px; margin-bottom:10px;">
  <button type="button" onclick="ins('+')">+</button>
  <button type="button" onclick="ins('-')">−</button>
  <button type="button" onclick="ins('*')">×</button>
  <button type="button" onclick="ins('/')">÷</button>
</div>

<button onclick="aggiungiImporto()">Aggiungi</button>

<div id="lista"></div>

<h3>Totale: € <span id="totale">0.00</span></h3>

<button onclick="calcola()">Calcola buoni pasto</button>

<div id="output"></div>

<script>
// =========== LOGICA DELL’APP ===========
let importi = [];

function aggiungiImporto() {
  const input = document.getElementById("importo");
  let expr = (input.value || "").trim();

  if (!expr) return;

  // Normalizza operatori visuali o alternativi
  expr = expr
    .replace(/×/g, "*")
    .replace(/[xX]/g, "*")
    .replace(/÷/g, "/")
    .replace(/,/g, "")      // se l'utente incolla con virgole separatrici
    .replace(/\s+/g, "");   // rimuovi spazi

  // ✅ Consenti solo cifre e operatori sicuri: + - * / ( )
  const safe = /^[0-9+\-*/()]+$/;
  if (!safe.test(expr)) {
    alert("Espressione non valida. Usa solo numeri e + - * / ( )");
    return;
  }

  // Valuta in modo controllato
  let valore;
  try {
    // Esegue come pura espressione aritmetica
    valore = Function("return (" + expr + ")")();
  } catch (e) {
    alert("Espressione non valida");
    return;
  }

  if (typeof valore !== "number" || !isFinite(valore) || valore <= 0) {
    alert("Risultato non valido");
    return;
  }

  // Lavoriamo in centesimi: arrotonda all'intero più vicino
  const valoreCentesimi = Math.round(valore);

  importi.push(valoreCentesimi);
  input.value = "";
  aggiornaLista();
  aggiornaTotale();
}

function aggiornaLista() {
    let html = "<h3>Importi:</h3><ul style='list-style:none;padding-left:0;'>";

    importi.forEach((v, i) => {
        const euro = (v / 100).toFixed(2);

        html += `
            <li style="display:flex; align-items:center; margin-bottom:10px;">
                <span style="flex:1;">€ ${euro}</span>
                <button class="edit-btn" onclick="modifica(${i})">✏️</button>
                <button class="remove-btn" onclick="rimuovi(${i})">❌</button>
            </li>
        `;
    });

    html += "</ul>";
    document.getElementById("lista").innerHTML = html;
}

function rimuovi(i) {
    importi.splice(i, 1);
    aggiornaLista();
    aggiornaTotale();
}

function modifica(i) {
    const nuovo = prompt("Nuovo importo in centesimi:", importi[i]);
    if (nuovo !== null && !isNaN(parseInt(nuovo)) && parseInt(nuovo) > 0) {
        importi[i] = parseInt(nuovo);
        aggiornaLista();
        aggiornaTotale();
    }
}

function aggiornaTotale() {
    const tot = importi.reduce((a, b) => a + b, 0);
    document.getElementById("totale").textContent = (tot / 100).toFixed(2);
}

function calcola() {
    const target = importi.reduce((a, b) => a + b, 0) / 100;

    const small = 7.50;
    const large = 11.35;

    let bestTotal = 0;
    let bestSmall = 0;
    let bestLarge = 0;

    for (let nLarge = 0; nLarge <= Math.floor(target / large); nLarge++) {
        for (let nSmall = 0; nSmall <= Math.floor(target / small); nSmall++) {
            let total = nLarge * large + nSmall * small;
            if (total <= target && total > bestTotal) {
                bestTotal = total;
                bestLarge = nLarge;
                bestSmall = nSmall;
            }
        }
    }

    document.getElementById("output").innerHTML = `
        <h3>Risultato:</h3>
        Totale spesa: € ${target.toFixed(2)}<br>
        Coperti dai buoni: € ${bestTotal.toFixed(2)}<br><br>
        Resto: € ${target.toFixed(2)}-{bestTotal.toFixed(2)}<br><br>
        Buoni da 11,35 €: <b>${bestLarge}</b><br>
        Buoni da 7,50 €: <b>${bestSmall}</b>
    `;
}

function ins(op) {
  const input = document.getElementById("importo");
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;

  input.value = input.value.slice(0, start) + op + input.value.slice(end);
  // riposiziona il cursore dopo l’operatore inserito
  const pos = start + op.length;
  requestAnimationFrame(() => {
    input.focus();
    input.setSelectionRange(pos, pos);
  });
}    
</script>

<script>
// =========== SERVICE WORKER ===========
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
}
</script>

<script>
// === REGISTRAZIONE SERVICE WORKER CON AGGIORNAMENTO FORZATO ===
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('service-worker.js', {
        // Evita di usare la cache HTTP per i file del SW
        updateViaCache: 'none'
      });

      // Forza subito un check del SW su ogni avvio
      reg.update().catch(() => {});

      // Se il SW invia NEW_VERSION, ricarichiamo (già presente, lo manteniamo)
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'NEW_VERSION') {
          console.log('Nuova versione disponibile → ricarico');
          window.location.reload();
        }
      });

      // Se cambia il controller (nuovo SW attivo), ricarica
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('controllerchange → ricarico');
        window.location.reload();
      });

      // Ogni volta che l’app torna in primo piano, ricontrolla aggiornamenti
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          reg.update().catch(() => {});
        }
      });

      // Controllo periodico (es. ogni 30s mentre è aperta)
      setInterval(() => reg.update().catch(() => {}), 30000);

    } catch (e) {
      console.warn('SW registration error:', e);
    }
  });
}
</script>
<footer style="margin-top:40px; text-align:center; opacity:0.6; font-size:0.9em;">
    Versione: <span id="versione">caricamento...</span>
</footer>

<script>
// === Mostra la versione del service worker nel footer ===
async function mostraVersioneSW() {
    try {
        // Forza un fetch senza cache
        const resp = await fetch("service-worker.js?nocache=" + Date.now());
        const testo = await resp.text();

        // Cerca la stringa VERSION = "qualcosa"
        const match = testo.match(/VERSION\s*=\s*["']([^"']+)["']/);

        if (match && match[1]) {
            document.getElementById("versione").textContent = match[1];
        } else {
            document.getElementById("versione").textContent = "n/d";
        }

    } catch (e) {
        document.getElementById("versione").textContent = "errore";
    }
}

mostraVersioneSW();
</script>
    
</body>

</html>







